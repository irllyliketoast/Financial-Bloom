<!-- HTML by: Laura Estremera, Javascript by: Temo Galindo, Daniela Luna, Mikaela Riggan -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Financial Bloom - Dashboard</title>

  <!-- External CSS -->
  <link rel="stylesheet" href="../Styles/Dashboard.css">

  <!-- Preconnecting to Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Font families used -->
  <link href="https://fonts.googleapis.com/css2?family=Silkscreen&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">

  <!-- Charts.css -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!--Pi-Chart Library-->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div id="customCursor"></div>
<!-- Header -->
<header class="header">
  <img src="../Graphics/logo.png" alt="Financial Bloom logo">
  Financial Bloom
</header>

<!-- Sidebar -->
<nav>
  <ul>
    <li id="current"><a href="Dashboard.html"><span class="material-symbols-outlined">home</span> Dashboard</a></li>
    <li><a href="BudgetIndex.html"><span class="material-symbols-outlined">wallet</span> Budget</a></li>
    <li><a href="GardenPath.html"><span class="material-symbols-outlined">flyover</span> Garden Path</a></li>
    <li><a href="Settings.html"><span class="material-symbols-outlined">settings</span> Settings</a></li>
    <li><a href="Login.html" class="logout"><span class="material-symbols-outlined">door_back</span> Exit</a></li>
  </ul>
</nav>

<!-- Main Layout -->
<main>
  <div class="left-section">
    <!-- Stats Cards -->
    <div class="stats-cards">
      <div class="card income">
        <h2>Income</h2>
        <p id="income-amount">$0</p>
      </div>
      <div class="card expenses">
        <h2>Expenses</h2>
        <p id="expenses-amount">$0</p>
      </div>
      <div class="card net">
        <h2>Net Gain</h2>
        <p id="net-amount">$0</p>
      </div>
    </div>

    <!-- Pie Chart -->
    <div class="chart-container">
      <h2>Spending Breakdown</h2>
      <canvas id="spendingPieChart" width="300" height="300"></canvas>
    </div>

      <!-- Milestone Contributions -->
    <div class="transactions-container">
      <h2>Recent Savings Contributions</h2>
      <table>
        <thead>
        <tr>
          <th>Milestone</th>
          <th>Contribution</th>
        </tr>
        </thead>
        <tbody id="milestone-body">
        <!-- Dynamic milestone contributions go here -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="right-section">
    <!-- Unity Game Embed -->
    <div id="unity-container">
      <iframe src="https://html-classic.itch.zone/html/13547535/finBloom/index.html" frameborder="0" width="800" height="500" style="border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2);"></iframe>
    </div>
  </div>
</main>

<!-- Footer -->
<footer>
  2025 Financial Bloom &copy; All rights reserved.
</footer>

<!-- JavaScript to Fetch Dashboard Data -->
<script src="../Scripts/required.js"></script>
<script>
  // Redirect user if they don't have a userId
  const userId = verifyUser();
  async function fetchDashboardData() {
    try {
      const response = await fetch(`http://localhost:8080/api/dashboard-data/${userId}`);
      const data = await response.json();

      let totalIncome = 0;
      let totalExpenses = 0;
      let totalSavings = 0;

      data.budgetData.forEach(entry => {
        if (entry.type === "Income") totalIncome += entry.amount;
        else totalExpenses += entry.amount;
      });

      if (data.milestone) {
        data.milestone.forEach(m => {
          totalSavings += m.amountSaved;
        });
      }

      const net = totalIncome - totalExpenses;

      // Update Stats
      document.getElementById('income-amount').innerText = `$${totalIncome}`;
      document.getElementById('expenses-amount').innerText = `$${totalExpenses}`;
      document.getElementById('net-amount').innerText = `$${net}`;

      if (window.myPieChart) {
        window.myPieChart.destroy();
      }

      const ctx = document.getElementById('spendingPieChart').getContext('2d');
      window.myPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Income', 'Expenses'],
          datasets: [{
            data: [totalIncome, totalExpenses],
            backgroundColor: ['#88d498', '#f67280'],
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: {
                  family: 'Play',
                  size: 14
                }
              }
            }
          }
        }
      });

      const milestoneBody = document.getElementById('milestone-body');
      milestoneBody.innerHTML = '';

      if (data.milestone) {
        data.milestone.forEach(entry => {
          const row = `<tr><td>${entry.name}</td><td>$${entry.amountSaved}</td></tr>`;
          milestoneBody.innerHTML += row;
        });
      }
    } catch (error) {
      console.error('Failed to load dashboard data:', error);
    }
  }

  //Logout functionality in required.js
  // Load dashboard data when page loads
  window.addEventListener('DOMContentLoaded', fetchDashboardData);
</script>

</body>
</html>